"use strict";(self.__LOADABLE_LOADED_CHUNKS__=self.__LOADABLE_LOADED_CHUNKS__||[]).push([[398],{10148:function(e,n,t){t.r(n),t.d(n,{_frontmatter:function(){return p},default:function(){return c}});var a=t(87462),i=t(63366),r=(t(67294),t(10498)),o=t(36904),s=["components"],p={},A={_frontmatter:p},l=o.Z;function c(e){var n=e.components,t=(0,i.Z)(e,s);return(0,r.kt)(l,(0,a.Z)({},A,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Recently I bought an iPad so I can live share my notes to my laptop during\nscreencasts. This is incredibly useful for online meetings, presentations, or\npair programming sessions where I want to show notes to whoever in real-time."),(0,r.kt)("p",null,"In this blog post, I'll explain how I setup screen mirroring from my iPad to a\nNixOS based setup. Whether you are using NixOS as your daily driver or just want\nto try out screen mirroring on a ","*","nix based system, hopefully my experience and\nlearnings can be helpful for you."),(0,r.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"An iPad with screen mirroring capabilities."),(0,r.kt)("li",{parentName:"ol"},"A laptop or desktop computer running ",(0,r.kt)("a",{parentName:"li",href:"https://nixos.org/"},"NixOS"),"."),(0,r.kt)("li",{parentName:"ol"},"Both devices connected to the same local network")),(0,r.kt)("p",null,"Note that for the rest of this tutorial I'm running NixOS 22.11 (Raccoon) and\nan iPad (6th gen) running iOS 16.2."),(0,r.kt)("h2",{id:"setting-up-an-airplay-receiver-on-nixos"},"Setting up an AirPlay receiver on NixOS"),(0,r.kt)("p",null,"Apple devices canonically talk to each other via ",(0,r.kt)("a",{parentName:"p",href:"https://www.apple.com/airplay/"},"AirPlay"),', so in order to\nmirror an iPad to NixOS, we need to setup an AirPlay "receiver" server.'),(0,r.kt)("p",null,"There are many open source AirPlay receivers, but I chose to use ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/FDH2/UxPlay"},"UxPlay")," simply\nbecause it was the first one I came across and it's in ",(0,r.kt)("inlineCode",{parentName:"p"},"nixpkgs"),"."),(0,r.kt)("p",null,"Now unfortunately if we start running the receiver via ",(0,r.kt)("inlineCode",{parentName:"p"},"nix run\n  nixpkgs#uxplay"),", the iPad won't see anything ðŸ˜“. This is expected though\nbecause the receiver has no way of interacting with the ",(0,r.kt)("a",{parentName:"p",href:"https://openairplay.github.io/airplay-spec/service_discovery.html"},"service discover"),"\nmechanism of AirPlay which is mDNS."),(0,r.kt)("p",null,"The UxPlay README recommends using ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/lathiat/avahi"},"Avahi")," for doing mDNS. Luckily ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/NixOS/nixpkgs/blob/release-22.11/nixos/modules/services/networking/avahi-daemon.nix"},"Avahi is\navailable for NixOS")," so we can add it too our ",(0,r.kt)("inlineCode",{parentName:"p"},"configuration.nix")," as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-nix"},"services.avahi = {\n  nssmdns = true;\n  enable = true;\n  publish = {\n    enable = true;\n    userServices = true;\n    domain = true;\n  };\n};\n")),(0,r.kt)("p",null,"Now after a ",(0,r.kt)("inlineCode",{parentName:"p"},"nixos-rebuild switch")," we should be running Avahi"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},'$ systemctl status avahi-daemon.service\n* avahi-daemon.service - Avahi mDNS/DNS-SD Stack\n     Loaded: loaded (/etc/systemd/system/avahi-daemon.service; enabled; preset: enabled)\n     Active: active (running) since Tue 2022-12-27 09:12:57 EST; 13s ago\nTriggeredBy: * avahi-daemon.socket\n   Main PID: 245105 (avahi-daemon)\n     Status: "Server startup complete."\n         IP: 8.8K in, 8.8K out\n         IO: 0B read, 0B written\n      Tasks: 1 (limit: 38114)\n     Memory: 628.0K\n        CPU: 22ms\n     CGroup: /system.slice/avahi-daemon.service\n             `-245105 "avahi-daemon: running [spam.local]"\n\nDec 27 09:12:57 spam avahi-daemon[245105]: New relevant interface lo.IPv4 for mDNS.\nDec 27 09:12:57 spam avahi-daemon[245105]: Network interface enumeration completed.\n...\n')),(0,r.kt)("p",null,"Now if we try running UxPlay again, we should see our AirPlay receiver show up\nin the screen mirror."),(0,r.kt)("p",null,(0,r.kt)("span",{parentName:"p",className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"886px"}},"\n      ",(0,r.kt)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"90.18058690744921%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAASABQDASIAAhEBAxEB/8QAGQABAAIDAAAAAAAAAAAAAAAAAAEDAgQF/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQIA/9oADAMBAAIQAxAAAAHnVzTcbCSWwM4jb//EABsQAAICAwEAAAAAAAAAAAAAAAECABADETFB/9oACAEBAAEFAnZteTJQ4Ia//8QAFhEAAwAAAAAAAAAAAAAAAAAAABAR/9oACAEDAQE/ASv/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAZEAABBQAAAAAAAAAAAAAAAAABABAgMVH/2gAIAQEABj8CGK2Ev//EABsQAQACAwEBAAAAAAAAAAAAAAEAIRARYTFB/9oACAEBAAE/IUD8citiCwgd6bl9gph6x//aAAwDAQACAAMAAAAQyyg8/8QAFhEBAQEAAAAAAAAAAAAAAAAAASEg/9oACAEDAQE/EBkw/8QAGBEAAgMAAAAAAAAAAAAAAAAAAAEQESH/2gAIAQIBAT8Qa0qf/8QAHRABAAMAAQUAAAAAAAAAAAAAAQARQTEQIVHh8P/aAAgBAQABPxDCTQlq+qHQO3InqO06TAFZEqmohZ4Jy6n/2Q==')",backgroundSize:"cover",display:"block"}}),"\n  ",(0,r.kt)("picture",{parentName:"span"},"\n          ",(0,r.kt)("source",{parentName:"picture",srcSet:["/static/368f9a50ff89a22b7e6035f2e9241af2/3fa74/ipad_screenshot.webp 886w"],sizes:"(max-width: 886px) 100vw, 886px",type:"image/webp"}),"\n          ",(0,r.kt)("source",{parentName:"picture",srcSet:["/static/368f9a50ff89a22b7e6035f2e9241af2/35822/ipad_screenshot.jpg 886w"],sizes:"(max-width: 886px) 100vw, 886px",type:"image/jpeg"}),"\n          ",(0,r.kt)("img",{parentName:"picture",className:"gatsby-resp-image-image",src:"/static/368f9a50ff89a22b7e6035f2e9241af2/35822/ipad_screenshot.jpg",alt:"img",title:"my iPad seeing UxPlay!",loading:"lazy",decoding:"async",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"}}),"\n        "),"\n    ")),(0,r.kt)("p",null,"This is great! However if we try to connect we will just end up with a\ntimeout. What gives?"),(0,r.kt)("p",null,"After breaking out Wireshark it was obvious that is was a firewall issue. The\nsimple remedy to this problem was to set ",(0,r.kt)("inlineCode",{parentName:"p"},"networking.firewall.enable = false;"),"\nin the ",(0,r.kt)("inlineCode",{parentName:"p"},"configuration.nix"),". But this is in general a bad idea and should be\navoided."),(0,r.kt)("p",null,"Instead I went with a uxplay + iptables + bash approach so while the uxplay is\nrunning, iptables will allow incoming traffic to all necessary ports, and on\nexit, will close them again."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'#! /usr/bin/env nix-shell\n#! nix-shell --quiet -p uxplay -i bash\n\nset -ueo pipefail\n\n## Clear any existing "DROP ME" rules\n## ref: https://stackoverflow.com/a/63855690/12393422\nwhile sudo iptables -L -n --line-number | grep "DROP ME" > /dev/null; do\n  sudo iptables -D INPUT $(sudo iptables -L -n --line-number | grep "DROP ME" | head -1 | awk \'{print $1}\');\ndone\n\n\nLOCAL_CIDR=${1:-"192.168.0.0/16"}\n\nopen-port-tcp() {\n  local port=$1\n  echo "Opening tcp port $port from $LOCAL_CIDR ..."\n  sudo iptables \\\n       -I INPUT \\\n       -p tcp \\\n       -s $LOCAL_CIDR \\\n       --dport $port \\\n       -j ACCEPT \\\n       -m comment --comment "DROP ME"\n}\n\nclose-port-tcp() {\n  local port=${1:-0}\n  echo "Closing tcp port $port from $LOCAL_CIDR ..."\n  sudo iptables \\\n       -D INPUT \\\n       -p tcp \\\n       -s $LOCAL_CIDR \\\n       --dport $port \\\n       -j ACCEPT \\\n       -m comment --comment "DROP ME"\n}\n\nopen-port-udp() {\n  local port=$1\n  echo "Opening udp port $port from $LOCAL_CIDR ..."\n  sudo iptables \\\n       -I INPUT \\\n       -p udp \\\n       -s $LOCAL_CIDR \\\n       --dport $port \\\n       -j ACCEPT \\\n       -m comment --comment "DROP ME"\n}\n\nclose-port-udp() {\n  local port=${1:-0}\n  echo "Closing udp port $port from $LOCAL_CIDR ..."\n  sudo iptables \\\n       -D INPUT \\\n       -p udp \\\n       -s $LOCAL_CIDR \\\n       --dport $port \\\n       -j ACCEPT \\\n       -m comment --comment "DROP ME"\n}\n\nopen-port-tcp 7100\nopen-port-tcp 7000\nopen-port-tcp 7001\nopen-port-udp 6000\nopen-port-udp 6001\nopen-port-udp 7011\n\n# Ensure port closes if error occurs.\ntrap "close-port-tcp 7100 && \\\n      close-port-tcp 7000 && \\\n      close-port-tcp 7001 && \\\n      close-port-udp 6000 && \\\n      close-port-udp 6001 && \\\n      close-port-udp 7011\n      " EXIT\n\nuxplay -p\n\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"$ ipad_screen_mirror_server\nOpening tcp port 7100 from 192.168.0.0/16 ...\nOpening tcp port 7000 from 192.168.0.0/16 ...\nOpening tcp port 7001 from 192.168.0.0/16 ...\nOpening udp port 6000 from 192.168.0.0/16 ...\nOpening udp port 6001 from 192.168.0.0/16 ...\nOpening udp port 7011 from 192.168.0.0/16 ...\nusing network ports UDP 7011 6001 6000 TCP 7100 7000 7001\nusing system MAC address xx:xx:xx:xx:xx:xx\nInitialized server socket(s)\n")),(0,r.kt)("p",null,"Here is the ",(0,r.kt)("a",{parentName:"p",href:"https://gist.github.com/cmrfrd/fe8f61da076f8a4a751bf8fc8cb579a5"},"gist")," for those interested."),(0,r.kt)("p",null,"Now wrapping all this code into a simple script gives us an easy way to easily\nspin up an AirPlay receiver server!"),(0,r.kt)("p",null,"If you want to learn more about screen mirroring or NixOS, here are some\nadditional resources you might find helpful:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"NixOS documentation (",(0,r.kt)("a",{parentName:"li",href:"https://nixos.org/manual/"},"https://nixos.org/manual/"),")"),(0,r.kt)("li",{parentName:"ul"},"mDNS RFC (",(0,r.kt)("a",{parentName:"li",href:"https://www.rfc-editor.org/rfc/rfc6762.html"},"https://www.rfc-editor.org/rfc/rfc6762.html"),")"),(0,r.kt)("li",{parentName:"ul"},"Publish a service with Avahi on NixOS\n(",(0,r.kt)("a",{parentName:"li",href:"https://blog.stigok.com/2019/12/09/nixos-avahi-publish-service.html"},"https://blog.stigok.com/2019/12/09/nixos-avahi-publish-service.html"),")"),(0,r.kt)("li",{parentName:"ul"},"OpenAirPlay Spec (",(0,r.kt)("a",{parentName:"li",href:"https://openairplay.github.io/airplay-spec/introduction.html"},"https://openairplay.github.io/airplay-spec/introduction.html"),")")),(0,r.kt)("p",null,"I hope you found this useful, let me know if you have any other tips or tricks\nfor screen mirroring on NixOS!"),(0,r.kt)("p",null,"(à¸‡ Í Â° ÍŸÙ„Íœ Í¡Â°)à¸‡"))}c.isMDXComponent=!0}}]);
//# sourceMappingURL=component---content-posts-12-setting-up-ipad-screen-mirroring-on-linux-index-mdx-7b764c3b98d1d5707d82.js.map